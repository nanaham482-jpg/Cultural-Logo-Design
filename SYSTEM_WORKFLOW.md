# 系统工作流文档

本文档详细说明智能Logo设计助手网站的底层运行机制、用户使用流程以及非遗文化数字化转化的实现方式。

## 📋 目录

1. [系统架构概览](#系统架构概览)
2. [底层运行工作流](#底层运行工作流)
3. [用户使用流程](#用户使用流程)
4. [非遗文化数字化转化实现](#非遗文化数字化转化实现)
5. [数据流转图](#数据流转图)
6. [技术实现细节](#技术实现细节)

---

## 一、系统架构概览

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      前端层 (Next.js)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  页面组件     │  │  聊天界面     │  │  图片展示     │    │
│  │  (page.tsx)  │  │ (MessageList)│  │ (ImageGrid)  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            ↕ HTTP/API
┌─────────────────────────────────────────────────────────────┐
│                    API路由层 (Next.js API Routes)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ 关键词提取API │  │  图片搜索API  │  │  Logo生成API  │    │
│  │/extract-key  │  │/search-images│  │/generate-logo│    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  AI服务封装   │  │  图片搜索逻辑  │  │  数据处理     │    │
│  │   (lib/ai.ts)│  │  (lib/oss.ts)│  │ (data/images)│    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                      外部服务层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  通义千问API  │  │   豆包API     │  │  阿里云OSS    │    │
│  │ (关键词提取)  │  │ (Logo生成)    │  │  (图片存储)   │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈分层

| 层级 | 技术 | 作用 |
|------|------|------|
| **前端UI** | React + TypeScript + TailwindCSS | 用户界面和交互 |
| **框架** | Next.js 15 (App Router) | 全栈框架，SSR/SSG |
| **API层** | Next.js API Routes | 后端API接口 |
| **业务逻辑** | TypeScript | 关键词提取、图片搜索、Logo生成 |
| **AI服务** | 通义千问 + 豆包 | 自然语言处理和图像生成 |
| **数据存储** | JSON文件 + OSS | 图片元数据和图片文件 |

---

## 二、底层运行工作流

### 2.1 完整请求流程

```
用户输入
   ↓
[前端: page.tsx]
   ├─ handleUserInput()
   └─ 状态管理 (useState)
   ↓
[API调用: /api/extract-keywords]
   ├─ 接收用户输入
   ├─ 调用 lib/ai.ts::extractKeywords()
   └─ 返回关键词数组
   ↓
[AI服务: 通义千问API]
   ├─ 模型: qwen-plus
   ├─ 输入: 用户文本 + 系统提示词
   ├─ 处理: 提取3-5个关键词
   └─ 输出: 关键词列表
   ↓
[API调用: /api/search-images]
   ├─ 接收关键词数组
   ├─ 调用 lib/oss.ts::searchImagesByTags()
   └─ 返回匹配图片列表
   ↓
[图片搜索: 匹配度评分系统]
   ├─ 加载 data/images.json (5000+条记录)
   ├─ 匹配度计算:
   │   ├─ 精确匹配: 10分
   │   ├─ 部分匹配: 5分
   │   └─ 同义词匹配: 2-3分
   ├─ 排序: 按匹配度降序
   └─ 返回: 最多20张图片
   ↓
[前端展示]
   ├─ 显示图片网格
   └─ 等待用户选择
   ↓
[用户选择图片]
   ├─ handleImageSelect()
   └─ 更新状态: currentStep = "generating"
   ↓
[用户输入风格描述]
   ├─ handleUserInput() (第二步)
   └─ 调用 /api/generate-logo
   ↓
[API调用: /api/generate-logo]
   ├─ 接收: 图片URL + 风格描述
   ├─ 调用 lib/ai.ts::generateLogo()
   └─ 返回: Logo图片URL
   ↓
[AI服务: 豆包API]
   ├─ 模型: doubao-seedream-4-0-250828
   ├─ 输入: 参考图片URL + 风格描述
   ├─ 处理: 图生图生成Logo
   └─ 输出: Logo图片URL
   ↓
[前端展示结果]
   ├─ 显示生成的Logo
   └─ 提供下载功能
```

### 2.2 关键技术流程详解

#### 流程1: 关键词提取流程

```typescript
用户输入: "我想做一个蒙古风格的logo"
   ↓
[通义千问API调用]
   ├─ System Prompt: 定义标签库类型和提取规则
   ├─ User Input: "请从以下文本中提取关键词：我想做一个蒙古风格的logo"
   ├─ Temperature: 0.3 (降低随机性，提高准确性)
   └─ Max Tokens: 150
   ↓
AI处理:
   ├─ 理解用户意图
   ├─ 匹配标签库类型
   └─ 提取关键词: ["蒙古", "传统", "草原", "游牧"]
   ↓
关键词清理:
   ├─ 分割: 支持逗号、顿号、换行符
   ├─ 过滤: 去除无意义词汇
   └─ 降级处理: 如果AI失败，使用本地关键词映射
   ↓
返回: ["蒙古", "传统", "草原"]
```

#### 流程2: 图片搜索匹配流程

```typescript
关键词: ["蒙古", "传统", "草原"]
   ↓
[加载图片数据]
   ├─ 从 data/images.json 加载所有图片
   └─ 过滤: status === "success" && tags存在
   ↓
[匹配度计算 - 对每张图片]
   For each image:
     For each keyword:
       ├─ 精确匹配检查 (10分)
       │   └─ img.tags.includes(keyword)
       ├─ 部分匹配检查 (5分)
       │   ├─ img.tag.includes(keyword)
       │   └─ keyword.includes(img.tag)
       └─ 同义词匹配检查 (2-3分)
           └─ synonymMap[keyword] 匹配
   ↓
[评分汇总]
   ├─ 计算总匹配度分数
   ├─ 记录匹配的标签
   └─ 要求: 至少匹配一个原始关键词
   ↓
[排序和筛选]
   ├─ 按匹配度降序排序
   └─ 取前20张图片
   ↓
返回: 匹配的图片列表
```

#### 流程3: Logo生成流程

```typescript
输入:
   ├─ 参考图片URL: "https://oss.../蒙古包.jpg"
   └─ 风格描述: "现代简约、扁平化、柔和的线条"
   ↓
[构建Prompt]
   prompt = `基于参考图片的风格，创建一个logo设计。
             要求：现代简约、扁平化、柔和的线条。
             参考图片风格：https://oss.../蒙古包.jpg。
             生成一个简洁、专业的logo，适合商业使用。`
   ↓
[豆包API调用]
   ├─ Model: doubao-seedream-4-0-250828
   ├─ Prompt: 构建的提示词
   ├─ Size: 1024x1024
   └─ Format: URL
   ↓
AI处理:
   ├─ 分析参考图片风格
   ├─ 理解风格描述
   ├─ 生成Logo设计
   └─ 返回图片URL
   ↓
返回: Logo图片URL
```

### 2.3 状态管理流程

```typescript
ChatState {
  currentStep: "input" | "selecting" | "generating" | "complete"
  messages: Message[]
  selectedImage: OSSImage | null
  isLoading: boolean
}

状态流转:
  "input" 
    → 用户输入需求
    → 提取关键词 + 搜索图片
    → "selecting"
    
  "selecting"
    → 用户选择图片
    → "generating"
    
  "generating"
    → 用户输入风格描述
    → 生成Logo
    → "complete"
    
  "complete"
    → 显示Logo结果
    → 可重新开始
```

---

## 三、用户使用流程

### 3.1 完整用户旅程

```
┌─────────────────────────────────────────────────────────┐
│                   用户使用流程图                          │
└─────────────────────────────────────────────────────────┘

步骤1: 访问网站
   ↓
用户打开浏览器，访问网站首页
   ↓
看到欢迎消息："欢迎使用智能Logo设计助手！请告诉我您想要设计的Logo风格。"
   ↓
步骤2: 输入需求
   ↓
用户在聊天框输入: "我想做一个蒙古风格的logo"
   ↓
系统显示: "正在处理..."
   ↓
步骤3: AI提取关键词
   ↓
系统调用通义千问API
   ↓
提取关键词: ["蒙古", "传统", "草原", "游牧"]
   ↓
步骤4: 搜索匹配图片
   ↓
系统从图片库搜索匹配的图片
   ↓
使用匹配度评分系统，找到最相关的图片
   ↓
步骤5: 展示图片列表
   ↓
系统显示: "根据您的需求，我找到了以下相关图片（关键词：蒙古、传统、草原）。请选择一张作为参考："
   ↓
右侧显示图片网格（最多20张）
   ↓
步骤6: 选择参考图片
   ↓
用户点击选择一张图片（如：蒙古包图片）
   ↓
系统显示: "您已选择图片：xxx.jpg。请描述您想要的风格，例如'现代简约、扁平化、柔和的线条'："
   ↓
步骤7: 输入风格描述
   ↓
用户输入: "现代简约、扁平化、柔和的线条"
   ↓
系统显示: "正在生成Logo..."
   ↓
步骤8: 生成Logo
   ↓
系统调用豆包API
   ↓
基于参考图片 + 风格描述生成Logo
   ↓
步骤9: 展示结果
   ↓
系统显示: "Logo生成完成！"
   ↓
展示生成的Logo图片
   ↓
提供下载按钮
   ↓
步骤10: 下载或重新开始
   ↓
用户下载Logo
   ↓
或点击"重新开始"按钮，返回步骤1
```

### 3.2 用户交互界面

```
┌─────────────────────────────────────────────────────────┐
│  头部: 智能Logo设计助手                    [重新开始]    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  左侧: 聊天区域                                         │
│  ┌─────────────────────────────────────────────┐      │
│  │ [系统] 欢迎使用智能Logo设计助手！...          │      │
│  │ [用户] 我想做一个蒙古风格的logo              │      │
│  │ [助手] 根据您的需求，我找到了以下相关图片...  │      │
│  │ [用户] 现代简约、扁平化                      │      │
│  │ [助手] Logo生成完成！                        │      │
│  └─────────────────────────────────────────────┘      │
│  ┌─────────────────────────────────────────────┐      │
│  │ [输入框] 输入您的需求...              [发送]  │      │
│  └─────────────────────────────────────────────┘      │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  右侧: 图片选择区                                       │
│  ┌─────────────────────────────────────────────┐      │
│  │ 选择参考图片                                 │      │
│  │ ┌────┐ ┌────┐ ┌────┐ ┌────┐              │      │
│  │ │图片1│ │图片2│ │图片3│ │图片4│              │      │
│  │ └────┘ └────┘ └────┘ └────┘              │      │
│  │ ...                                        │      │
│  └─────────────────────────────────────────────┘      │
│  ┌─────────────────────────────────────────────┐      │
│  │ 已选择的图片                                 │      │
│  │ ┌─────────────────────────────────────┐    │      │
│  │ │         [选中的图片]                 │    │      │
│  │ └─────────────────────────────────────┘    │      │
│  └─────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────┘
```

---

## 四、非遗文化数字化转化实现

### 4.1 数字化转化架构

```
┌─────────────────────────────────────────────────────────────┐
│              非遗文化数字化转化实现架构                       │
└─────────────────────────────────────────────────────────────┘

物理世界 (非遗文化)
   ↓ 数字化采集
┌─────────────────────────────────────────────────────────┐
│  1. 图片数字化                                           │
│     ├─ 拍摄非遗文化实物照片                              │
│     ├─ 上传到阿里云OSS存储                               │
│     └─ 生成可访问的URL                                   │
└─────────────────────────────────────────────────────────┘
   ↓ 标签化处理
┌─────────────────────────────────────────────────────────┐
│  2. 标签化标注                                           │
│     ├─ 为每张图片添加多维度标签                          │
│     │   ├─ 文化类型: 蒙古族、藏式、伊斯兰等             │
│     │   ├─ 建筑类型: 寺庙、古建筑、传统建筑等           │
│     │   ├─ 装饰元素: 彩绘、砖雕、龙纹、经幡等            │
│     │   ├─ 颜色特征: 金色、蓝色、红色等                 │
│     │   └─ 文化特征: 文化传承、传统工艺、吉祥等          │
│     └─ 存储到 data/images.json                           │
└─────────────────────────────────────────────────────────┘
   ↓ 知识化处理
┌─────────────────────────────────────────────────────────┐
│  3. 知识图谱构建                                         │
│     ├─ 同义词映射表 (synonymMap)                         │
│     │   ├─ 文化主题映射: 伊斯兰→清真寺、阿拉伯等         │
│     │   ├─ 建筑风格映射: 传统→传统建筑、古建筑等         │
│     │   └─ 装饰元素映射: 龙→龙纹、龙柱、金龙等           │
│     └─ 语义关联网络                                      │
└─────────────────────────────────────────────────────────┘
   ↓ AI智能化
┌─────────────────────────────────────────────────────────┐
│  4. AI语义理解                                           │
│     ├─ 通义千问理解用户自然语言                          │
│     ├─ 提取文化关键词                                    │
│     └─ 匹配非遗文化标签库                                │
└─────────────────────────────────────────────────────────┘
   ↓ 智能匹配
┌─────────────────────────────────────────────────────────┐
│  5. 智能搜索匹配                                         │
│     ├─ 匹配度评分系统                                    │
│     ├─ 多维度标签匹配                                    │
│     └─ 返回最相关的非遗文化图片                           │
└─────────────────────────────────────────────────────────┘
   ↓ 创意转化
┌─────────────────────────────────────────────────────────┐
│  6. 创意设计生成                                         │
│     ├─ 基于非遗文化元素                                  │
│     ├─ 结合现代设计风格                                  │
│     └─ 生成Logo设计                                      │
└─────────────────────────────────────────────────────────┘
   ↓ 应用输出
数字产品 (Logo设计)
```

### 4.2 非遗文化数据体系

#### 4.2.1 文化类型分类

基于 `data/images.json` 中的实际数据，系统涵盖以下非遗文化类型：

**1. 宗教建筑文化**
- 清真大寺（伊斯兰文化）
- 大召无量寺（藏传佛教）
- 席力图召（藏传佛教）

**2. 蒙古族文化**
- 蒙古包营造技艺
- 蒙古族服饰
- 蒙古族音乐（马头琴、呼麦）
- 蒙古族舞蹈（安代舞、萨吾尔登）
- 游牧文化

**3. 传统工艺**
- 彩绘工艺
- 砖雕、木雕、石雕
- 刺绣工艺
- 皮雕工艺（蒙古古皮艺）
- 传统纹样

**4. 民族乐器**
- 马头琴
- 四胡
- 潮尔
- 阿斯尔

**5. 传统体育**
- 曲棍球
- 抢枢

**6. 其他非遗**
- 鄂温克族文化
- 达斡尔族文化
- 鄂伦春族文化

#### 4.2.2 标签体系

系统使用多维度标签体系对非遗文化进行标注：

```
标签维度:
├─ 文化类型
│   ├─ 蒙古族、藏式、伊斯兰、鄂温克族等
│   └─ 文化传承、传统文化、宗教文化等
│
├─ 建筑类型
│   ├─ 清真寺、寺庙、古建筑、传统建筑等
│   └─ 中式建筑、藏式建筑、蒙古包等
│
├─ 装饰元素
│   ├─ 彩绘、砖雕、木雕、浮雕等
│   ├─ 龙纹、莲花、经幡、法轮等
│   └─ 传统纹样、吉祥图案等
│
├─ 颜色特征
│   └─ 金色、蓝色、红色、绿色、灰色等
│
└─ 风格特征
    ├─ 庄严、吉祥、祈福等
    └─ 传统工艺、文化传承等
```

### 4.3 数字化转化实现方式

#### 方式1: 图片数字化存储

```typescript
// 1. 图片上传到OSS
图片文件 → 阿里云OSS → 生成URL
   ↓
// 2. 元数据存储
{
  "image_url": "https://oss.../清真大寺/DSC_7911.JPG",
  "tags": ["清真寺", "宣礼塔", "中式屋顶", "蓝色", "灰色", "新月", "庄严", "文化融合"],
  "status": "success"
}
   ↓
// 3. 存储到 data/images.json
JSON数组格式，便于程序读取和搜索
```

#### 方式2: 语义化标签系统

```typescript
// 同义词映射表实现文化语义关联
const synonymMap = {
  // 宗教/文化主题
  伊斯兰: ["清真寺", "阿拉伯", "穆斯林", "伊斯兰教", "清真", "星月", "新月"],
  佛教: ["寺庙", "藏传佛教", "藏密"],
  
  // 建筑风格
  传统: ["传统建筑", "传统风格", "古建筑", "中式建筑", "传统工艺"],
  藏式: ["藏式建筑", "藏式寺庙", "藏式风格", "藏式装饰"],
  
  // 装饰元素
  彩绘: ["彩绘装饰", "古建筑彩绘", "传统建筑彩绘", "木雕彩绘"],
  龙: ["龙纹", "龙柱", "龙浮雕", "金龙", "双龙浮雕"],
  
  // 蒙古族文化
  蒙古: ["蒙古族", "蒙古包", "游牧", "草原"],
  马头琴: ["蒙古族乐器", "传统音乐", "民族文化"],
}
```

#### 方式3: AI语义理解

```typescript
// 通义千问理解用户自然语言
用户输入: "我想做一个蒙古风格的logo"
   ↓
System Prompt定义:
  - 图片标签库包含：建筑类型、文化主题、装饰元素、颜色、风格特征
  - 优先提取：文化/宗教主题、建筑风格、装饰元素、风格特征
   ↓
AI提取: ["蒙古", "传统", "草原", "游牧"]
   ↓
匹配非遗文化标签库
```

#### 方式4: 智能匹配算法

```typescript
// 匹配度评分系统
For each 非遗文化图片:
  计算匹配度分数:
    - 精确匹配: 10分 (如: 标签包含"蒙古")
    - 部分匹配: 5分 (如: 标签包含"蒙古族")
    - 同义词匹配: 3分 (如: 通过"蒙古"匹配"蒙古包")
   ↓
按匹配度排序
   ↓
返回最相关的非遗文化图片
```

#### 方式5: 创意设计生成

```typescript
// 基于非遗文化元素生成现代Logo
输入:
  - 参考图片: 蒙古包图片（非遗文化元素）
  - 风格描述: "现代简约、扁平化"（现代设计风格）
   ↓
豆包API处理:
  - 分析参考图片中的非遗文化特征
  - 理解现代设计风格要求
  - 融合非遗文化元素与现代设计
   ↓
输出:
  - 融合非遗文化的现代Logo设计
```

### 4.4 非遗文化数字化转化的价值

#### 4.4.1 文化保护

- **数字化保存**: 将非遗文化实物转化为数字图片，永久保存
- **标签化整理**: 通过标签系统，建立非遗文化知识库
- **可检索性**: 用户可以通过自然语言搜索非遗文化元素

#### 4.4.2 文化传播

- **在线展示**: 非遗文化图片在线展示，打破地域限制
- **智能推荐**: AI理解用户需求，智能推荐相关非遗文化
- **可视化呈现**: 通过图片网格，直观展示非遗文化

#### 4.4.3 文化创新

- **创意转化**: 将非遗文化元素转化为现代Logo设计
- **风格融合**: 结合传统与现代，创造新的设计
- **应用拓展**: 非遗文化元素应用于商业设计

#### 4.4.4 文化教育

- **知识图谱**: 通过标签和同义词映射，建立文化关联
- **交互学习**: 用户通过搜索和选择，了解非遗文化
- **文化认知**: 帮助用户认识和理解不同文化类型

---

## 五、数据流转图

### 5.1 完整数据流

```
┌─────────────────────────────────────────────────────────┐
│                   数据流转图                              │
└─────────────────────────────────────────────────────────┘

用户输入文本
   ↓
[前端] page.tsx::handleUserInput()
   ↓ HTTP POST
[API] /api/extract-keywords
   ↓
[业务逻辑] lib/ai.ts::extractKeywords()
   ↓ HTTP POST
[外部服务] 通义千问API
   ├─ Input: 用户文本 + 系统提示词
   ├─ Model: qwen-plus
   └─ Output: 关键词文本
   ↓
[数据处理] 关键词清理和提取
   ├─ 分割: split(/[,，、\n]/)
   ├─ 过滤: 去除无意义词
   └─ 降级: 如果失败，使用本地映射
   ↓
关键词数组: ["蒙古", "传统", "草原"]
   ↓ HTTP POST
[API] /api/search-images
   ↓
[业务逻辑] lib/oss.ts::searchImagesByTags()
   ↓
[数据加载] data/images.json
   ├─ 加载所有图片数据 (5000+条)
   └─ 过滤: status === "success"
   ↓
[匹配计算] 对每张图片计算匹配度
   ├─ 精确匹配: 10分
   ├─ 部分匹配: 5分
   └─ 同义词匹配: 2-3分
   ↓
[排序筛选] 按匹配度排序，取前20
   ↓
图片列表: OSSImage[]
   ↓ HTTP Response
[前端] 展示图片网格
   ↓
用户选择图片
   ↓
[前端] page.tsx::handleImageSelect()
   ↓
用户输入风格描述
   ↓ HTTP POST
[API] /api/generate-logo
   ↓
[业务逻辑] lib/ai.ts::generateLogo()
   ├─ 构建Prompt: 参考图片 + 风格描述
   └─ HTTP POST
[外部服务] 豆包API
   ├─ Model: doubao-seedream-4-0-250828
   ├─ Input: Prompt + 参考图片URL
   └─ Output: Logo图片URL
   ↓
Logo图片URL
   ↓ HTTP Response
[前端] 展示Logo结果
```

### 5.2 数据存储结构

```typescript
// data/images.json 数据结构
[
  {
    "image_url": "https://oss.../清真大寺/DSC_7911.JPG",
    "tags": [
      "清真寺",        // 建筑类型
      "宣礼塔",        // 建筑元素
      "中式屋顶",      // 建筑风格
      "蓝色",          // 颜色特征
      "灰色",          // 颜色特征
      "新月",          // 文化符号
      "庄严",          // 风格特征
      "文化融合"       // 文化特征
    ],
    "status": "success"
  },
  // ... 5000+条记录
]

// 前端数据结构
interface OSSImage {
  url: string;        // 图片URL
  name: string;      // 文件名
  tags: string[];    // 标签数组
}

// 消息数据结构
interface Message {
  id: string;
  role: "user" | "assistant" | "system";
  content: string;
  timestamp: Date;
  type?: "text" | "image-list" | "image-selection" | "logo-result";
  data?: {
    images?: OSSImage[];
    selectedImage?: OSSImage;
    generatedLogo?: string;
    keywords?: string[];
  };
}
```

---

## 六、技术实现细节

### 6.1 关键词提取实现

```typescript
// lib/ai.ts::extractKeywords()

1. 环境检查
   - 检查 QWEN_API_KEY 是否存在

2. API调用
   - Endpoint: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
   - Method: POST
   - Headers: Authorization Bearer Token
   - Body: {
       model: "qwen-plus",
       input: {
         messages: [
           {
             role: "system",
             content: "关键词提取助手提示词..."
           },
           {
             role: "user",
             content: "请从以下文本中提取关键词：${userInput}"
           }
         ]
       },
       parameters: {
         temperature: 0.3,
         max_tokens: 150
       }
     }

3. 响应处理
   - 提取: data.output.choices[0].message.content
   - 清理: 分割、过滤、去重

4. 降级处理
   - 如果AI失败，使用本地关键词映射表
   - extractKeywordsFallback()
```

### 6.2 图片搜索实现

```typescript
// lib/oss.ts::searchImagesByTags()

1. 数据加载
   - loadImagesData(): 从 data/images.json 加载
   - 类型转换: ImageDataItem[] → OSSImage[]

2. 匹配度计算
   For each image:
     For each searchTag:
       - 精确匹配: imgTagsLower.includes(searchTagLower) → 10分
       - 部分匹配: imgTagLower.includes(searchTagLower) → 5分
       - 同义词匹配: synonymMap[searchTag] 匹配 → 2-3分
     - 汇总分数
     - 记录匹配标签

3. 筛选条件
   - matchScore > 0
   - 至少匹配一个原始搜索标签（不是同义词）

4. 排序和限制
   - 按 matchScore 降序排序
   - slice(0, 20): 返回最多20张

5. 返回结果
   - OSSImage[]: 包含 url, name, tags
```

### 6.3 Logo生成实现

```typescript
// lib/ai.ts::generateLogo()

1. 环境检查
   - 检查 DOUBAO_API_KEY 是否存在

2. Prompt构建
   prompt = `基于参考图片的风格，创建一个logo设计。
             要求：${styleDescription}。
             参考图片风格：${imageUrl}。
             生成一个简洁、专业的logo，适合商业使用。`

3. API调用
   - Endpoint: https://ark.cn-beijing.volces.com/api/v3/images/generations
   - Method: POST
   - Headers: Authorization Bearer Token
   - Body: {
       model: "doubao-seedream-4-0-250828",
       prompt: prompt,
       size: "1024x1024",
       n: 1,
       response_format: "url"
     }

4. 响应处理
   - 提取: data.data[0].url 或 data.images[0].url
   - 返回Logo图片URL

5. 错误处理
   - 如果失败，返回模拟URL（开发测试）
```

### 6.4 前端状态管理

```typescript
// app/page.tsx

状态结构:
const [state, setState] = useState<ChatState>({
  messages: Message[],           // 聊天消息列表
  selectedImage: OSSImage | null, // 选中的图片
  isLoading: boolean,            // 加载状态
  currentStep: "input" | "selecting" | "generating" | "complete"
})

状态流转:
1. "input" → handleUserInput()
   - 调用 /api/extract-keywords
   - 调用 /api/search-images
   - 更新 messages
   - 设置 currentStep = "selecting"

2. "selecting" → handleImageSelect()
   - 更新 selectedImage
   - 更新 messages
   - 设置 currentStep = "generating"

3. "generating" → handleUserInput()
   - 调用 /api/generate-logo
   - 更新 messages
   - 设置 currentStep = "complete"

4. "complete" → handleReset()
   - 重置所有状态
   - 设置 currentStep = "input"
```

---

## 七、非遗文化数字化转化的核心价值

### 7.1 文化保护层面

1. **数字化存档**
   - 将非遗文化实物转化为数字图片
   - 存储在云端（OSS），永久保存
   - 建立完整的标签体系

2. **知识结构化**
   - 通过标签系统，建立文化知识库
   - 同义词映射，建立文化关联网络
   - 便于检索和查询

### 7.2 文化传播层面

1. **在线展示**
   - 打破地域限制，在线展示非遗文化
   - 用户可以通过自然语言搜索
   - 智能推荐相关文化内容

2. **交互体验**
   - 聊天式交互，降低使用门槛
   - 可视化展示，直观了解文化
   - 选择式操作，增强参与感

### 7.3 文化创新层面

1. **创意转化**
   - 将非遗文化元素转化为现代设计
   - AI辅助设计，提高效率
   - 融合传统与现代

2. **应用拓展**
   - Logo设计应用
   - 商业设计应用
   - 文化创意产品

### 7.4 文化教育层面

1. **知识学习**
   - 通过搜索了解不同文化类型
   - 标签系统帮助理解文化特征
   - 图片展示增强视觉认知

2. **文化认知**
   - 了解蒙古族、藏式、伊斯兰等文化
   - 认识传统工艺、建筑风格等
   - 理解文化传承的意义

---

## 八、系统优势

### 8.1 技术优势

- ✅ **AI驱动**: 使用大模型理解自然语言，提取文化关键词
- ✅ **智能匹配**: 匹配度评分系统，确保结果相关性
- ✅ **高效搜索**: 本地JSON数据，快速搜索5000+图片
- ✅ **现代架构**: Next.js全栈框架，前后端一体化

### 8.2 文化价值

- ✅ **数字化保护**: 非遗文化数字化存储和展示
- ✅ **知识化整理**: 标签体系建立文化知识库
- ✅ **智能化检索**: AI理解用户需求，智能匹配文化元素
- ✅ **创意化转化**: 将传统文化转化为现代设计

### 8.3 用户体验

- ✅ **简单易用**: 聊天式交互，自然语言输入
- ✅ **直观展示**: 图片网格展示，可视化选择
- ✅ **快速响应**: 本地数据搜索，响应速度快
- ✅ **结果可靠**: 匹配度评分，确保结果相关性

---

## 九、未来优化方向

### 9.1 技术优化

1. **数据库迁移**: 从JSON文件迁移到数据库（MongoDB/PostgreSQL）
2. **缓存机制**: 添加Redis缓存，提高搜索性能
3. **CDN加速**: 使用CDN加速图片加载
4. **搜索引擎**: 集成Elasticsearch，支持全文搜索

### 9.2 功能扩展

1. **多语言支持**: 支持英文、蒙文等多语言搜索
2. **高级筛选**: 支持按颜色、风格、文化类型筛选
3. **收藏功能**: 用户可以收藏喜欢的图片
4. **历史记录**: 保存用户的设计历史

### 9.3 文化深化

1. **文化详情**: 为每张图片添加文化背景介绍
2. **文化故事**: 添加非遗文化的故事和传说
3. **视频内容**: 支持视频格式的文化展示
4. **3D展示**: 支持3D模型展示（如建筑）

---

**文档版本**: 1.0  
**最后更新**: 2025-01-XX


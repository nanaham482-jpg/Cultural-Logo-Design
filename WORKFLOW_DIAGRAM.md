# 工作流可视化图表

## 📊 系统运行流程图

### 完整请求流程

```
┌─────────────────────────────────────────────────────────────┐
│                      用户操作层                              │
│                                                             │
│  用户输入: "我想做一个蒙古风格的logo"                        │
│         ↓                                                   │
│  选择图片: 点击选中参考图片                                  │
│         ↓                                                   │
│  输入风格: "现代简约、扁平化"                                │
│         ↓                                                   │
│  获得Logo: 下载生成的Logo                                   │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                      前端界面层                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  page.tsx (主页面)                                  │   │
│  │  ├─ 状态管理: ChatState                             │   │
│  │  ├─ 消息列表: MessageList                           │   │
│  │  ├─ 图片网格: ImageGrid                             │   │
│  │  └─ 聊天输入: ChatInput                             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↕ HTTP/API
┌─────────────────────────────────────────────────────────────┐
│                      API路由层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │/extract-key  │  │/search-images│  │/generate-logo│     │
│  │  关键词提取   │  │   图片搜索    │  │   Logo生成   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  lib/ai.ts   │  │  lib/oss.ts  │  │ data/images │     │
│  │              │  │              │  │    .json    │     │
│  │ extractKeywords()│searchImages()│  │  5000+图片  │     │
│  │ generateLogo()   │ 匹配度评分   │  │  标签数据   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────────┐
│                      外部服务层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  通义千问API  │  │   豆包API     │  │  阿里云OSS   │     │
│  │              │  │              │  │              │     │
│  │ qwen-plus    │  │seedream-4.0  │  │ 图片存储     │     │
│  │ 关键词提取    │  │ Logo生成     │  │ URL访问      │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 详细数据流

### 阶段1: 关键词提取

```
用户输入文本
    ↓
[前端] page.tsx::handleUserInput()
    ↓ POST /api/extract-keywords
[API路由] extract-keywords/route.ts
    ↓
[业务逻辑] lib/ai.ts::extractKeywords()
    ├─ 构建System Prompt（定义标签库类型）
    ├─ 构建User Input（用户文本）
    └─ 调用通义千问API
        ↓
[AI服务] 通义千问 (qwen-plus)
    ├─ 理解用户意图
    ├─ 匹配标签库类型
    └─ 提取关键词: ["蒙古", "传统", "草原"]
        ↓
[数据处理] 关键词清理
    ├─ 分割: split(/[,，、\n]/)
    ├─ 过滤: 去除无意义词
    └─ 降级: 如果失败，使用本地映射
        ↓
返回关键词数组
```

### 阶段2: 图片搜索匹配

```
关键词数组: ["蒙古", "传统", "草原"]
    ↓ POST /api/search-images
[API路由] search-images/route.ts
    ↓
[业务逻辑] lib/oss.ts::searchImagesByTags()
    ├─ 加载 data/images.json (5000+条)
    ├─ 过滤: status === "success"
    └─ 对每张图片计算匹配度
        ↓
[匹配度计算]
    For each image:
        For each keyword:
            ├─ 精确匹配: 10分
            ├─ 部分匹配: 5分
            └─ 同义词匹配: 2-3分
        ↓
    汇总分数 + 记录匹配标签
        ↓
[排序筛选]
    ├─ 按匹配度降序排序
    ├─ 要求: 至少匹配一个原始关键词
    └─ 取前20张图片
        ↓
返回图片列表: OSSImage[]
```

### 阶段3: Logo生成

```
用户选择图片 + 输入风格描述
    ↓ POST /api/generate-logo
[API路由] generate-logo/route.ts
    ↓
[业务逻辑] lib/ai.ts::generateLogo()
    ├─ 构建Prompt: 参考图片 + 风格描述
    └─ 调用豆包API
        ↓
[AI服务] 豆包 (doubao-seedream-4-0-250828)
    ├─ 分析参考图片风格
    ├─ 理解风格描述
    ├─ 融合非遗文化元素与现代设计
    └─ 生成Logo图片
        ↓
返回Logo图片URL
    ↓
[前端] 展示Logo结果 + 下载功能
```

## 🎨 用户使用流程图

```
开始
  ↓
┌─────────────────────────────────┐
│ 1. 访问网站                      │
│    看到欢迎消息                  │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 2. 输入需求                      │
│    "我想做一个蒙古风格的logo"    │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 3. AI提取关键词                  │
│    通义千问 → ["蒙古","传统"]    │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 4. 搜索匹配图片                   │
│    匹配度评分 → 找到相关图片      │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 5. 展示图片列表                   │
│    显示20张最相关的图片           │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 6. 选择参考图片                   │
│    点击选中一张图片               │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 7. 输入风格描述                   │
│    "现代简约、扁平化"             │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 8. 生成Logo                      │
│    豆包API → 融合传统与现代       │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 9. 展示结果                       │
│    显示生成的Logo                │
└─────────────────────────────────┘
  ↓
┌─────────────────────────────────┐
│ 10. 下载或重新开始                │
│     下载Logo / 重新设计          │
└─────────────────────────────────┘
```

## 🏛️ 非遗文化数字化转化流程

```
物理世界 (非遗文化)
    ↓
┌─────────────────────────────────┐
│ 数字化采集                        │
│ ├─ 拍摄: 清真寺、寺庙、蒙古包等   │
│ ├─ 上传: 阿里云OSS存储            │
│ └─ URL: 生成可访问的图片链接      │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 标签化标注                        │
│ ├─ 文化类型: 蒙古族、藏式、伊斯兰 │
│ ├─ 建筑类型: 寺庙、古建筑等       │
│ ├─ 装饰元素: 彩绘、砖雕、龙纹等   │
│ ├─ 颜色特征: 金色、蓝色、红色等   │
│ └─ 文化特征: 文化传承、传统工艺等 │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 知识图谱构建                      │
│ ├─ 同义词映射: 建立文化关联      │
│ ├─ 语义网络: 文化元素关联        │
│ └─ 标签体系: 多维度分类          │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ AI语义理解                       │
│ ├─ 通义千问: 理解自然语言        │
│ ├─ 关键词提取: 匹配文化标签      │
│ └─ 智能匹配: 找到相关文化元素    │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 创意设计生成                      │
│ ├─ 参考图片: 非遗文化元素        │
│ ├─ 风格描述: 现代设计风格        │
│ ├─ 豆包API: 融合传统与现代       │
│ └─ Logo输出: 文化创意产品        │
└─────────────────────────────────┘
    ↓
数字产品 (Logo设计)
```

## 🔍 匹配度评分系统详解

```
搜索关键词: ["蒙古", "传统"]

For each 图片 in 图片库:
    matchScore = 0
    
    For each keyword in ["蒙古", "传统"]:
        ├─ 精确匹配检查
        │   if img.tags.includes("蒙古"):
        │       matchScore += 10
        │       matchedTags.push("蒙古")
        │
        ├─ 部分匹配检查
        │   if img.tag.includes("蒙古") or "蒙古".includes(img.tag):
        │       matchScore += 5
        │       matchedTags.push("蒙古")
        │
        └─ 同义词匹配检查
            if synonymMap["蒙古"] 匹配到 img.tags:
                matchScore += 3
                matchedTags.push("蒙古")
    
    if matchScore > 0 and 至少匹配一个原始关键词:
        scoredImages.push({
            image: img,
            score: matchScore,
            matchedTags: matchedTags
        })

排序: scoredImages.sort((a, b) => b.score - a.score)
返回: scoredImages.slice(0, 20)
```

## 📈 状态流转图

```
┌─────────┐
│  input  │ ←──┐
└────┬────┘    │
     │         │
     │ 用户输入需求
     ↓         │
┌─────────────┐│
│  selecting  ││
└────┬────────┘│
     │         │
     │ 选择图片 │
     ↓         │
┌─────────────┐│
│ generating  ││
└────┬────────┘│
     │         │
     │ 输入风格 │
     ↓         │
┌─────────────┐│
│  complete   ││
└────┬────────┘│
     │         │
     │ 重新开始 │
     └─────────┘
```

## 🎯 核心功能模块

```
┌─────────────────────────────────────────┐
│           核心功能模块                    │
├─────────────────────────────────────────┤
│                                          │
│  1. 关键词提取模块                        │
│     ├─ 通义千问API调用                    │
│     ├─ 自然语言理解                      │
│     └─ 关键词提取和清理                  │
│                                          │
│  2. 图片搜索模块                          │
│     ├─ 数据加载 (JSON)                   │
│     ├─ 匹配度计算                        │
│     ├─ 同义词扩展                        │
│     └─ 排序和筛选                        │
│                                          │
│  3. Logo生成模块                         │
│     ├─ Prompt构建                        │
│     ├─ 豆包API调用                       │
│     └─ 图片生成和返回                    │
│                                          │
│  4. 状态管理模块                          │
│     ├─ 聊天状态管理                      │
│     ├─ 消息列表管理                      │
│     └─ UI状态控制                        │
│                                          │
└─────────────────────────────────────────┘
```

---

**详细说明请参考**: [SYSTEM_WORKFLOW.md](./SYSTEM_WORKFLOW.md)


